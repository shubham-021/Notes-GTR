---
title: SSH
description: Secure Shell protocol explained from basics to advanced usage
---

## What is SSH?

SSH (Secure Shell) is a cryptographic network protocol for secure communication between two computers over an unsecured network. It provides:

- **Encrypted communication** - All data is encrypted in transit
- **Authentication** - Verify identity of both client and server
- **Integrity** - Detect any tampering of data
- **Remote command execution** - Run commands on remote machines
- **File transfer** - Securely copy files (via SCP/SFTP)
- **Port forwarding** - Tunnel other protocols through SSH

SSH replaced older insecure protocols like Telnet, rlogin, and rsh.

---

## Key Terminology

| Term | Definition |
|------|------------|
| **Client** | The computer initiating the connection (your laptop) |
| **Server/Host** | The remote computer you connect to |
| **SSH Daemon (sshd)** | The server-side process that listens for connections |
| **Port 22** | Default port SSH listens on |
| **Public Key** | The key you share with servers (like a padlock) |
| **Private Key** | The key you keep secret (like the key to the padlock) |
| **Fingerprint** | A hash of a key for easy verification |
| **Known Hosts** | List of servers you've connected to before |
| **Agent** | Program that holds your keys in memory |

---

## How SSH Works

### The Connection Process

1. **TCP Connection**: Client connects to server on port 22
2. **Protocol Negotiation**: Client and server agree on SSH version and algorithms
3. **Key Exchange**: Generate a shared secret using Diffie-Hellman
4. **Server Authentication**: Server proves its identity using its host key
5. **Client Authentication**: Client proves its identity (password or key)
6. **Session**: Encrypted channel is established

### Encryption Layers

SSH uses multiple encryption mechanisms:

1. **Symmetric Encryption**: Fast encryption for the session data (AES, ChaCha20)
2. **Asymmetric Encryption**: Used for key exchange and authentication (RSA, Ed25519)
3. **Hashing**: Verify data integrity (SHA-256)

---

## Basic SSH Usage

### Connecting to a Server

```bash
ssh username@hostname
ssh username@192.168.1.100
ssh user@example.com
```

### Specifying a Port

```bash
ssh -p 2222 username@hostname    # Connect on port 2222
```

### First Connection

When connecting to a new server, you'll see:

```
The authenticity of host 'example.com (93.184.216.34)' can't be established.
ED25519 key fingerprint is SHA256:abc123...
Are you sure you want to continue connecting (yes/no/[fingerprint])?
```

This is the **host key verification**. The server is proving its identity. Type `yes` to accept and add it to your known hosts file (`~/.ssh/known_hosts`).

---

## SSH Keys

SSH keys provide passwordless, more secure authentication.

### Understanding Key Pairs

- **Private Key** (`~/.ssh/id_ed25519`): Never share this. It stays on your computer.
- **Public Key** (`~/.ssh/id_ed25519.pub`): Share freely. Add to servers you want to access.

Think of it like this:
- Public key = A padlock you give to others
- Private key = The only key that opens that padlock

### Generating SSH Keys

```bash
ssh-keygen -t ed25519 -C "your_email@example.com"
```

Options explained:
- `-t ed25519`: Key type (Ed25519 is modern and secure)
- `-C "comment"`: A comment/label for the key

You'll be prompted for:
1. **File location**: Press Enter for default (`~/.ssh/id_ed25519`)
2. **Passphrase**: Optional but recommended extra security

#### Key Types

| Type | Command | Notes |
|------|---------|-------|
| Ed25519 | `ssh-keygen -t ed25519` | Recommended. Modern, fast, secure. |
| RSA | `ssh-keygen -t rsa -b 4096` | Widely compatible. Use 4096 bits. |
| ECDSA | `ssh-keygen -t ecdsa -b 521` | Elliptic curve. Good performance. |

Ed25519 is preferred for new keys unless you need compatibility with old systems.

### Viewing Your Public Key

```bash
cat ~/.ssh/id_ed25519.pub
```

Output looks like:

```
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILxJ... your_email@example.com
```

---

## Adding Your Key to a Server

### Method 1: ssh-copy-id (Recommended)

```bash
ssh-copy-id username@hostname
```

This automatically:
- Connects to the server
- Creates `~/.ssh` directory if needed
- Appends your public key to `~/.ssh/authorized_keys`
- Sets correct permissions

### Method 2: Manual Copy

```bash
# Copy your public key
cat ~/.ssh/id_ed25519.pub

# SSH to server with password
ssh username@hostname

# On the server, add key to authorized_keys
mkdir -p ~/.ssh
chmod 700 ~/.ssh
echo "paste-your-public-key-here" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

### Method 3: One-liner

```bash
cat ~/.ssh/id_ed25519.pub | ssh username@hostname "mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys"
```

---

## SSH Config File

Create `~/.ssh/config` to define shortcuts and default settings.

```bash
# Simple host alias
Host myserver
    HostName 192.168.1.100
    User admin
    Port 22

# Now you can just type:
# ssh myserver

# Production server with specific key
Host prod
    HostName prod.example.com
    User deploy
    IdentityFile ~/.ssh/prod_key
    Port 2222

# Jump through bastion host
Host internal
    HostName 10.0.0.50
    User admin
    ProxyJump bastion

Host bastion
    HostName bastion.example.com
    User admin

# GitHub
Host github.com
    HostName github.com
    User git
    IdentityFile ~/.ssh/github_key

# Wildcard for all hosts
Host *
    AddKeysToAgent yes
    IdentitiesOnly yes
    ServerAliveInterval 60
    ServerAliveCountMax 3
```

### Common Config Options

| Option | Description |
|--------|-------------|
| `Host` | Alias for the connection |
| `HostName` | Actual hostname or IP |
| `User` | Username to connect as |
| `Port` | SSH port (default 22) |
| `IdentityFile` | Path to private key |
| `ProxyJump` | Jump through another host |
| `ForwardAgent` | Forward SSH agent to server |
| `LocalForward` | Set up local port forwarding |
| `ServerAliveInterval` | Keep connection alive (seconds) |

---

## SSH Agent

The SSH agent holds your private keys in memory so you don't have to enter your passphrase repeatedly.

### Starting the Agent

```bash
# Start agent (usually automatic on modern systems)
eval "$(ssh-agent -s)"
```

### Adding Keys to Agent

```bash
ssh-add ~/.ssh/id_ed25519           # Add specific key
ssh-add                              # Add default key
ssh-add -l                           # List loaded keys
ssh-add -D                           # Remove all keys
```

### Agent on macOS

macOS Keychain can store your passphrase:

```bash
ssh-add --apple-use-keychain ~/.ssh/id_ed25519
```

Add to `~/.ssh/config`:

```
Host *
    AddKeysToAgent yes
    UseKeychain yes
```

---

## File Transfer

### SCP (Secure Copy)

```bash
# Upload file to server
scp file.txt username@hostname:/path/to/destination/

# Download file from server
scp username@hostname:/path/to/file.txt ./local/

# Copy directory recursively
scp -r folder/ username@hostname:/path/to/destination/

# Using different port
scp -P 2222 file.txt username@hostname:/path/

# Using config alias
scp file.txt myserver:/path/
```

### SFTP (SSH File Transfer Protocol)

Interactive file transfer:

```bash
sftp username@hostname
```

SFTP commands:

```
ls              # List remote files
lls             # List local files
cd folder       # Change remote directory
lcd folder      # Change local directory
get file.txt    # Download file
put file.txt    # Upload file
get -r folder   # Download directory
put -r folder   # Upload directory
rm file.txt     # Delete remote file
mkdir folder    # Create remote directory
exit            # Quit
```

### rsync over SSH

Efficient file synchronization:

```bash
# Sync local to remote
rsync -avz ./folder/ username@hostname:/path/to/destination/

# Sync remote to local
rsync -avz username@hostname:/path/to/folder/ ./local/

# With progress
rsync -avz --progress ./folder/ username@hostname:/path/

# Delete files on destination that don't exist on source
rsync -avz --delete ./folder/ username@hostname:/path/
```

Flags:
- `-a`: Archive mode (preserves permissions, timestamps, etc.)
- `-v`: Verbose
- `-z`: Compress during transfer
- `--progress`: Show progress
- `--delete`: Delete extraneous files from destination

---

## Port Forwarding (Tunneling)

### Local Port Forwarding

Access a remote service through a local port.

```bash
ssh -L local_port:remote_host:remote_port username@ssh_server
```

Example: Access remote database through localhost:

```bash
ssh -L 5433:localhost:5432 username@db-server.com
# Now connect to localhost:5433 to reach the remote PostgreSQL
```

Example: Access internal web server:

```bash
ssh -L 8080:internal-server:80 username@bastion.com
# Open http://localhost:8080 to access internal-server:80
```

### Remote Port Forwarding

Expose a local service to the remote network.

```bash
ssh -R remote_port:local_host:local_port username@ssh_server
```

Example: Expose local dev server:

```bash
ssh -R 8080:localhost:3000 username@server.com
# Users on server.com can access your local :3000 via their :8080
```

### Dynamic Port Forwarding (SOCKS Proxy)

Create a SOCKS proxy to route any traffic through SSH:

```bash
ssh -D 1080 username@hostname
```

Configure your browser to use `localhost:1080` as a SOCKS5 proxy. All traffic goes through the SSH tunnel.

### Persistent Tunneling

Background tunnel with auto-reconnect:

```bash
ssh -f -N -L 5433:localhost:5432 username@hostname
```

Flags:
- `-f`: Background after authentication
- `-N`: No remote command (just forwarding)

---

## Jump Hosts (Bastion)

Connect through an intermediate server.

### ProxyJump (Modern Method)

```bash
ssh -J bastion@bastion.example.com user@internal-server
```

Or in config:

```
Host internal
    HostName 10.0.0.50
    User admin
    ProxyJump bastion

Host bastion
    HostName bastion.example.com
    User admin
```

Then just:

```bash
ssh internal
```

### ProxyCommand (Legacy Method)

```
Host internal
    HostName 10.0.0.50
    User admin
    ProxyCommand ssh -W %h:%p bastion
```

---

## Running Remote Commands

### Single Command

```bash
ssh username@hostname "ls -la"
ssh username@hostname "df -h"
ssh username@hostname "cat /var/log/app.log | tail -20"
```

### Multiple Commands

```bash
ssh username@hostname "cd /app && git pull && npm install"
```

### Run Script Locally on Remote

```bash
ssh username@hostname < local_script.sh
```

### Interactive Commands

```bash
ssh -t username@hostname "sudo apt update"
```

The `-t` flag allocates a pseudo-terminal, required for interactive commands like `sudo`.

---

## Security Best Practices

### Disable Password Authentication

On the server, edit `/etc/ssh/sshd_config`:

```
PasswordAuthentication no
PubkeyAuthentication yes
```

Restart SSH:

```bash
sudo systemctl restart sshd
```

### Change Default Port

```
Port 2222
```

### Disable Root Login

```
PermitRootLogin no
```

### Limit Users

```
AllowUsers alice bob
AllowGroups sshusers
```

### Use Fail2Ban

Install fail2ban to block repeated failed attempts:

```bash
sudo apt install fail2ban
```

### Key Passphrase

Always use a passphrase on your private key. If someone gets your key file, they still need the passphrase.

---

## Troubleshooting

### Verbose Output

```bash
ssh -v username@hostname    # Verbose
ssh -vv username@hostname   # More verbose
ssh -vvv username@hostname  # Maximum verbosity
```

### Common Issues

#### Permission Denied (publickey)

1. Check your public key is in `~/.ssh/authorized_keys` on server
2. Check permissions:
   ```bash
   # On server
   chmod 700 ~/.ssh
   chmod 600 ~/.ssh/authorized_keys
   ```
3. Check you're using the correct key:
   ```bash
   ssh -i ~/.ssh/specific_key username@hostname
   ```

#### Host Key Verification Failed

The server's key changed (or someone is intercepting):

```bash
# Remove old key (only if you trust the change)
ssh-keygen -R hostname
```

#### Connection Timed Out

1. Check server is running: `ping hostname`
2. Check SSH service: `sudo systemctl status sshd`
3. Check firewall allows port 22
4. Check correct port: `ssh -p 2222 username@hostname`

#### Connection Refused

1. SSH daemon not running
2. Firewall blocking
3. Wrong port

### Debug SSH Server

On the server:

```bash
sudo tail -f /var/log/auth.log      # Debian/Ubuntu
sudo tail -f /var/log/secure        # CentOS/RHEL
```

---

## SSH Directory Structure

```
~/.ssh/
    id_ed25519           # Private key (KEEP SECRET)
    id_ed25519.pub       # Public key (share freely)
    config               # SSH client configuration
    known_hosts          # Servers you've connected to
    authorized_keys      # (on server) Keys allowed to connect
```

### Correct Permissions

```bash
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_ed25519          # Private key
chmod 644 ~/.ssh/id_ed25519.pub      # Public key
chmod 644 ~/.ssh/known_hosts
chmod 644 ~/.ssh/config
chmod 600 ~/.ssh/authorized_keys     # On server
```

---

## Quick Reference

### Connection

```bash
ssh user@host                    # Basic connection
ssh -p 2222 user@host            # Custom port
ssh -i ~/.ssh/mykey user@host    # Specific key
ssh -v user@host                 # Verbose/debug
```

### Keys

```bash
ssh-keygen -t ed25519            # Generate key
ssh-copy-id user@host            # Copy key to server
ssh-add ~/.ssh/key               # Add to agent
ssh-add -l                       # List agent keys
```

### File Transfer

```bash
scp file user@host:/path/        # Upload
scp user@host:/path/file ./      # Download
scp -r folder user@host:/path/   # Directory
rsync -avz src/ user@host:dst/   # Sync
```

### Tunneling

```bash
ssh -L 8080:localhost:80 user@host   # Local forward
ssh -R 8080:localhost:80 user@host   # Remote forward
ssh -D 1080 user@host                # SOCKS proxy
```

### Jump Host

```bash
ssh -J jump@bastion user@internal    # Via jump host
```
